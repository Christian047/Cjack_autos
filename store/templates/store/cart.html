{% extends 'main.html' %}
{% load static %}
{% block content %}
{% load humanize %}

<br>
<section class="container p-4 pt-4"> 
    <div class="row">
        <div class="col-lg-12">
            <div class="box-element">
                <div class="cart-actions">
                    <a class="btn btn-outline-dark" href="{% url 'home' %}">&#x2190; Continue Shopping</a>
                    <a class="btn btn-sm btn-danger" href="#" onclick="confirmClearCart(event)">Clear Cart</a>
                </div>
                <br>
                <table class="table cart-summary">
                    <tr>
                        <th><h5>Items: <strong>{{order.get_cart_items}}</strong></h5></th>
                        <th><h5>Total:<strong> ₦{{order.get_cart_total|intcomma}}</strong></h5></th>
                        <th>
                            <a style="float:right;" class="checkout" href="{% url 'checkout' %}">Checkout</a>
                        </th>
                    </tr>
                </table>
            </div>
            <br>
            <div class="box-element">
                <!-- Desktop Table Header (visible on larger screens) -->
                <div class="cart-row desktop-header d-none d-md-flex">
                    <div style="flex:1"></div>
                    <div style="flex:1"><strong>Item</strong></div>
                    <div style="flex:1"><strong>Price</strong></div>
                    <div style="flex:1"><strong>Quantity</strong></div>
                    <div style="flex:1"><strong>Total</strong></div>
                    <div style="flex:1"></div>
                </div>
                
                {% if items %}
                    {% for item in items %}
                    <!-- Desktop Version -->
                    <div class="cart-row desktop-item d-none d-md-flex">
                        <div style="flex:1">
                            <img class="thumbnail" src="{{ item.product.picture.url }}">
                        </div>
                        <div style="flex:1"><p>{{ item.product.name }}</p></div>
                        <div style="flex:1"><p>₦{{ item.product.price|intcomma }}</p></div>
                        <div style="flex:1">
                            <div class="quantity-controls">
                                {% if request.user.is_authenticated %}
                                <input type="number" data-product="{{ item.product.id }}" class="quantity-input" 
                                       value="{{ item.quantity }}" min="1" max="100">
                                {% else %}
                                <p>{{ item.quantity }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div style="flex:1"><p>₦{{ item.get_total|intcomma }}</p></div>
                        <div style="flex:1">
                            {% if request.user.is_authenticated %}
                            <a href="{% url 'remove_from_cart' item.product.id %}" class="btn btn-sm btn-danger">✕</a>
                            {% else %}
                            <button class="btn btn-sm btn-danger" onclick="removeGuestItem('{{ item.product.id }}')">✕</button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Mobile Version -->
                    <div class="mobile-item d-md-none">
                        <div class="mobile-item-header">
                            <img class="thumbnail" src="{{ item.product.picture.url }}">
                            <div class="mobile-item-info">
                                <h6>{{ item.product.name }}</h6>
                                <p class="price">₦{{ item.product.price|intcomma }}</p>
                            </div>
                        </div>
                        <div class="mobile-item-footer">
                            <div class="mobile-quantity">
                                {% if request.user.is_authenticated %}
                                <input type="number" data-product="{{ item.product.id }}" class="quantity-input" 
                                       value="{{ item.quantity }}" min="1" max="100">
                                <span class="quantity-label">Qty:</span>
                                {% else %}
                                <p>Quantity: {{ item.quantity }}</p>
                                {% endif %}
                            </div>
                            <div class="mobile-total">
                                <p class="total-label">Total:</p>
                                <p class="total-price">₦{{ item.get_total|intcomma }}</p>
                            </div>
                            <div class="mobile-remove">
                                {% if request.user.is_authenticated %}
                                <a href="{% url 'remove_from_cart' item.product.id %}" class="btn btn-sm btn-danger">Remove</a>
                                {% else %}
                                <button class="btn btn-sm btn-danger" onclick="removeGuestItem('{{ item.product.id }}')">Remove</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-cart">
                        <p>Your cart is empty. <a href="{% url 'store' %}">Continue shopping</a>.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
    .thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    /* Desktop Styles */
    .cart-row {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .desktop-header {
        font-weight: bold;
        border-bottom: 2px solid #333;
        padding: 10px 0;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-input {
        width: 60px;
        padding: 5px;
        text-align: center;
    }
    
    /* Mobile Styles */
    .mobile-item {
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .mobile-item-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
    }
    
    .mobile-item-info {
        flex-grow: 1;
    }
    
    .mobile-item-info h6 {
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .price {
        color: #666;
        font-size: 0.9rem;
    }
    
    .mobile-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .mobile-quantity {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .mobile-total {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .total-label {
        color: #666;
    }
    
    .total-price {
        font-weight: bold;
    }
    
    .empty-cart {
        text-align: center;
        padding: 20px;
    }
    
    /* Responsive Visibility */
    @media (min-width: 768px) {
        .mobile-item {
            display: none;
        }
    }
    
    @media (max-width: 767px) {
        .desktop-header,
        .desktop-item {
            display: none;
        }
    }
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all quantity inputs
    var quantityInputs = document.getElementsByClassName('quantity-input');
    for (var i = 0; i < quantityInputs.length; i++) {
        quantityInputs[i].addEventListener('change', function() {
            var productId = this.dataset.product;
            var quantity = this.value;
            updateQuantity(productId, quantity);
        });
    }
    
    function updateQuantity(productId, quantity) {
        // Send AJAX request to update quantity
        var url = "{% url 'update_quantity' %}";
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'product_id': productId,
                'quantity': quantity
            })
        })
        .then(response => {
            // Reload page after successful update
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Function to get CSRF token
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Guest user cart functions
function removeGuestItem(productId) {
    // Get existing cart from cookies
    let cart = {};
    if (document.cookie.includes('cart')) {
        cart = JSON.parse(getCookie('cart'));
    }
    
    // Delete this product from cart
    if (cart[productId]) {
        delete cart[productId];
    }
    
    // Save to cookie and reload
    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/";
    location.reload();
}

// Confirm before clearing cart
function confirmClearCart(event) {
    event.preventDefault();
    
    // Handle different for guest vs authenticated users
    var user = '{{ request.user }}';
    if (user === 'AnonymousUser') {
        if (confirm("Are you sure you want to clear your cart? This action cannot be undone.")) {
            document.cookie = 'cart={}; domain=; path=/';
            location.reload();
        }
    } else {
        if (confirm("Are you sure you want to clear your cart? This action cannot be undone.")) {
            window.location.href = "{% url 'clear_cart' %}";
        }
    }
}

// Helper function to get cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock content %}