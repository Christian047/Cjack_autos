{% extends 'main.html' %}
{% load static %}
{% block content %}
{% load humanize %}

<br>
<br>
<section class="container p-4 pt-4"> 
    <div class="row">
        <div class="col-lg-12">
            <div class="box-element">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                    <a class="btn btn-outline-dark" href="{% url 'home' %}">&#x2190; Continue Shopping</a>
                    <a class="btn btn-sm btn-danger" href="#" onclick="confirmClearCart(event)">Clear Cart</a>
                </div>
                <br>
                <br>
                <table class="table">
                    <tr>
                        <th><h5>Items: <strong>{{order.get_cart_items}}</strong></h5></th>
                        <th><h5>Total:<strong> ₦{{order.get_cart_total|intcomma}}</strong></h5></th>
                        <th>
                            <a style="float:right;" class="checkout" href="{% url 'checkout' %}">Checkout</a>
                        </th>
                    </tr>
                </table>
            </div>
            <br>
            <div class="box-element">
                <div class="cart-row">
                    <div style="flex:1"></div>
                    <div style="flex:1"><strong>Item</strong></div>
                    <div style="flex:1"><strong>Price</strong></div>
                    <div style="flex:4"><strong>Quantity</strong></div>
                    <div style="flex:1"><strong>Total</strong></div>
                    <div style="flex:1"></div>
                </div>
                
                {% if items %}
                    {% for item in items %}
                    <div class="cart-row">
                        <div style="flex:1">
                            <img class="row-image thumbnail" src="{{ item.product.picture.url }}">
                        </div>
                        <div style="flex:1"><p class="small-text">{{ item.product.name }}</p></div>
                        <div style="flex:1"><p class="small-text">₦{{ item.product.price|intcomma }}</p></div>
                        <div style="flex:4">
                            <div style="display: flex; align-items: center;">
                                {% if request.user.is_authenticated %}
                                <input type="number" data-product="{{ item.product.id }}" class="quantity-input" 
                                       value="{{ item.quantity }}" min="1" max="100" 
                                       style="width: 50px; height: 30px; margin-right: 5px;">
                                {% else %}
                                <p class="small-text" style="margin-right: 5px;">{{ item.quantity }}</p>
                                {% endif %}
                                
                                {% if request.user.is_authenticated %}
                                <a href="{% url 'remove_from_cart' item.product.id %}" class="btn btn-sm btn-danger btn-xs">✕</a>
                                {% else %}
                                <button class="btn btn-sm btn-danger btn-xs" onclick="removeGuestItem('{{ item.product.id }}')">✕</button>
                                {% endif %}
                            </div>
                        </div>
                        <div style="flex:1"><p class="small-text">₦{{ item.get_total|intcomma }}</p></div>
                        <div style="flex:1"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="cart-row">
                        <div style="flex:5; text-align: center; padding: 20px;">
                            <p>Your cart is empty. <a href="{% url 'store' %}">Continue shopping</a>.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
    .thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
    }
    
    .small-text {
        font-size: 0.85rem;
        margin-bottom: 0;
    }
    
    .btn-xs {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
    }

    .cart-row {
        display: flex;
        align-items: center;
        padding: 10px 0;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .cart-row {
            display: flex;
            flex-wrap: wrap;
            padding: 8px 0;
        }

        .cart-row > div {
            padding: 2px;
        }
    }
</style>





<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all quantity inputs
    var quantityInputs = document.getElementsByClassName('quantity-input');
    for (var i = 0; i < quantityInputs.length; i++) {
        quantityInputs[i].addEventListener('change', function() {
            var productId = this.dataset.product;
            var quantity = this.value;
            updateQuantity(productId, quantity);
        });
    }
    
    function updateQuantity(productId, quantity) {
        // Send AJAX request to update quantity
        var url = "{% url 'update_quantity' %}";
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'product_id': productId,
                'quantity': quantity
            })
        })
        .then(response => {
            // Reload page after successful update
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Function to get CSRF token
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Guest user cart functions
function removeGuestItem(productId) {
    // Get existing cart from cookies
    let cart = {};
    if (document.cookie.includes('cart')) {
        cart = JSON.parse(getCookie('cart'));
    }
    
    // Delete this product from cart
    if (cart[productId]) {
        delete cart[productId];
    }
    
    // Save to cookie and reload
    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/";
    location.reload();
}

// Confirm before clearing cart
function confirmClearCart(event) {
    event.preventDefault();
    
    // Handle different for guest vs authenticated users
    var user = '{{ request.user }}';
    if (user === 'AnonymousUser') {
        if (confirm("Are you sure you want to clear your cart? This action cannot be undone.")) {
            document.cookie = 'cart={}; domain=; path=/';
            location.reload();
        }
    } else {
        if (confirm("Are you sure you want to clear your cart? This action cannot be undone.")) {
            window.location.href = "{% url 'clear_cart' %}";
        }
    }
}

// Helper function to get cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock content %}